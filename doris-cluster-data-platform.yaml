apiVersion: doris.selectdb.com/v1
kind: DorisCluster
metadata:
  labels:
    app.kubernetes.io/name: doriscluster
    app.kubernetes.io/instance: doriscluster-sample
    app.kubernetes.io/part-of: doris-operator
  name: doriscluster-sample
  namespace: data-platform
spec:
  feSpec:
    replicas: 3
    limits:
      cpu: 4
      memory: 8Gi
    requests:
      cpu: 2
      memory: 4Gi
    image: apache/doris:fe-2.1.8
    
    # Override init command to make swapoff non-fatal (|| true)
    systemInitialization:
      command:
        - /bin/sh
      args:
        - -c
        - (sysctl -w vm.max_map_count=2000000 || true) && (swapoff -a || true)
    
    # Persistent volumes for FE (metadata storage)
    persistentVolumes:
      - persistentVolumeClaimSpec:
          accessModes:
            - ReadWriteOnce
          storageClassName: local-storage-standard
          resources:
            requests:
              storage: 50Gi
        mountPath: /opt/apache-doris/fe/doris-meta
        name: fe-meta-storage
    
    # Security context for FE pods
    containerSecurityContext:
      privileged: true
      runAsUser: 0
  
  beSpec:
    replicas: 3
    limits:
      cpu: 4
      memory: 8Gi
    requests:
      cpu: 2
      memory: 4Gi
    image: apache/doris:be-2.1.8

    # Skip operator-provided default init (swapoff) because it requires host-level privileges
    skipDefaultSystemInit: true
    
    # Override init command to make swapoff non-fatal (|| true)
    systemInitialization:
      command:
        - /bin/sh
      args:
        - -c
        - (sysctl -w vm.max_map_count=2000000 || true) && (swapoff -a || true)
    
    # Security context for BE pods
    containerSecurityContext:
      privileged: true
      runAsUser: 0
    
    envVars:
      - name: SKIP_CHECK_ULIMIT
        value: "true"
    
    # Persistent volumes for BE (data storage)
    persistentVolumes:
      - persistentVolumeClaimSpec:
          accessModes:
            - ReadWriteOnce
          storageClassName: local-storage-standard
          resources:
            requests:
              storage: 100Gi
        mountPath: /opt/apache-doris/be/storage
        name: be-data-storage
