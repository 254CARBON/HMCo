name: Supply Chain Security and E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  k8s_validate:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v3.13.3'
    
    - name: Install kubeconform
      run: |
        curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | tar xz
        sudo mv kubeconform /usr/local/bin/
        kubeconform -v
    
    - name: Validate Kubernetes manifests
      run: |
        echo "Validating Kubernetes manifests..."
        EXIT_CODE=0
        find k8s -name '*.yaml' -o -name '*.yml' | while read -r file; do
          echo "Validating $file"
          if ! kubeconform -summary -ignore-missing-schemas "$file"; then
            echo "Warning: Validation issues in $file"
            EXIT_CODE=1
          fi
        done
        exit $EXIT_CODE
    
    - name: Lint Helm charts
      run: |
        echo "Linting Helm charts..."
        for chart in helm/charts/*/; do
          if [ -f "$chart/Chart.yaml" ]; then
            echo "Linting $(basename "$chart")..."
            helm lint "$chart" || exit 1
          fi
        done
        
        # Lint nested charts in data-platform
        for chart in helm/charts/data-platform/charts/*/; do
          if [ -f "$chart/Chart.yaml" ]; then
            echo "Linting $(basename "$chart")..."
            helm lint "$chart" || exit 1
          fi
        done
    
    - name: Template Helm charts
      run: |
        echo "Testing Helm template rendering..."
        
        # Test data-platform chart if it exists
        if [ -f "helm/charts/data-platform/Chart.yaml" ]; then
          echo "Templating data-platform chart..."
          if [ -f "helm/charts/data-platform/values/dev.yaml" ]; then
            helm template data-platform helm/charts/data-platform \
              --values helm/charts/data-platform/values/dev.yaml \
              --debug
          else
            helm template data-platform helm/charts/data-platform --debug
          fi
        fi
    
    - name: Validate ArgoCD applications
      run: |
        echo "Validating ArgoCD application manifests..."
        if [ -f "k8s/gitops/argocd-applications.yaml" ]; then
          kubeconform -summary -ignore-missing-schemas k8s/gitops/argocd-applications.yaml
        fi

  sbom_and_sign:
    name: SBOM Generation and Signing
    runs-on: ubuntu-latest
    needs: k8s_validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Install Syft for SBOM generation
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.0.1
        syft version
    
    - name: Install Cosign for signing
      uses: sigstore/cosign-installer@v3.4.0
      with:
        cosign-release: 'v2.2.3'
    
    - name: Generate SBOM for Python services
      run: |
        echo "Generating SBOM for Python services..."
        mkdir -p sbom-output
        
        # Generate SBOM for services with requirements.txt
        for service_dir in services/*/; do
          if [ -f "$service_dir/requirements.txt" ]; then
            service_name=$(basename "$service_dir")
            echo "Generating SBOM for $service_name..."
            syft dir:"$service_dir" -o "spdx-json=sbom-output/${service_name}-sbom.spdx.json"
          fi
        done
    
    - name: Generate SBOM for repository
      run: |
        echo "Generating SBOM for entire repository..."
        syft dir:. -o spdx-json=sbom-output/repository-sbom.spdx.json
        syft dir:. -o cyclonedx-json=sbom-output/repository-sbom.cdx.json
    
    - name: Scan for vulnerabilities with Grype
      run: |
        echo "Installing Grype..."
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin v0.74.7
        
        echo "Scanning for vulnerabilities..."
        grype dir:. --fail-on critical --output table
    
    - name: Build test image for signing (PR only)
      if: github.event_name == 'pull_request'
      run: |
        echo "Building test image for verification..."
        # Try different Dockerfile locations
        if [ -f "backend/Dockerfile" ]; then
          echo "Building backend image..."
          docker build -f backend/Dockerfile -t test-image:${{ github.sha }} ./backend
        elif [ -f "portal/Dockerfile" ]; then
          echo "Building portal image..."
          docker build -f portal/Dockerfile -t test-image:${{ github.sha }} ./portal
        else
          echo "No primary Dockerfile found for testing, skipping image build"
        fi
    
    - name: Build and push images
      if: github.event_name != 'pull_request'
      run: |
        echo "Building and pushing images..."
        # Build backend or portal image (primary deployable artifacts)
        if [ -f "backend/Dockerfile" ]; then
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}"
          docker build -f backend/Dockerfile -t "$IMAGE_TAG" ./backend
          docker push "$IMAGE_TAG"
          echo "IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_TAG")" >> "$GITHUB_ENV"
        elif [ -f "portal/Dockerfile" ]; then
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-portal:${{ github.sha }}"
          docker build -f portal/Dockerfile -t "$IMAGE_TAG" ./portal
          docker push "$IMAGE_TAG"
          echo "IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_TAG")" >> "$GITHUB_ENV"
        else
          echo "No primary Dockerfile found for deployment"
        fi
    
    - name: Sign container image
      if: github.event_name != 'pull_request'
      env:
        COSIGN_EXPERIMENTAL: "true"
      run: |
        if [ -n "$IMAGE_DIGEST" ]; then
          echo "Signing image with cosign..."
          cosign sign --yes $IMAGE_DIGEST
        else
          echo "No image to sign"
        fi
    
    - name: Sign SBOM artifacts
      env:
        COSIGN_EXPERIMENTAL: "true"
      run: |
        echo "Signing SBOM files..."
        for sbom_file in sbom-output/*.json; do
          if [ -f "$sbom_file" ]; then
            echo "Signing $sbom_file..."
            cosign sign-blob --yes "$sbom_file" --output-signature "${sbom_file}.sig"
          fi
        done
    
    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-files
        path: sbom-output/
        retention-days: 90
    
    - name: Generate SBOM summary
      run: |
        {
          echo "## SBOM Generation Summary"
          echo ""
          echo "Generated SBOMs:"
          ls -lh sbom-output/
        } >> "$GITHUB_STEP_SUMMARY"

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [k8s_validate, sbom_and_sign]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-timeout requests
        
        # Install test requirements if they exist
        if [ -f "tests/requirements.txt" ]; then
          pip install -r tests/requirements.txt
        fi
        
        # Install service dependencies for testing
        # Note: We continue on error here as some services may have conflicting deps
        # The actual tests will fail if required dependencies are missing
        for service_dir in services/*/; do
          if [ -f "$service_dir/requirements.txt" ]; then
            echo "Installing dependencies for $(basename "$service_dir")..."
            pip install -r "$service_dir/requirements.txt" || echo "Warning: Some dependencies failed to install for $(basename "$service_dir")"
          fi
        done
    
    - name: Set up Kind cluster
      uses: helm/kind-action@v1.9.0
      with:
        version: v0.20.0
        kubectl_version: v1.28.0
        cluster_name: test-cluster
    
    - name: Verify cluster
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Install Helm charts to cluster (smoke test)
      run: |
        echo "Testing Helm chart deployment..."
        
        # Create test namespace
        kubectl create namespace data-platform-test
        
        # Try to install a lightweight chart if available
        # Note: This may fail due to missing dependencies/CRDs, which is acceptable
        if [ -f "helm/charts/data-platform/Chart.yaml" ]; then
          echo "Performing dry-run of data-platform chart..."
          if helm install data-platform-test helm/charts/data-platform \
            --namespace data-platform-test \
            --dry-run --debug; then
            echo "Dry-run successful"
          else
            echo "Dry-run failed - this is acceptable if CRDs are missing"
          fi
        fi
    
    - name: Run E2E tests
      env:
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: testdb
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: |
        echo "Running E2E tests..."
        
        # Run E2E tests if they exist
        if [ -d "tests/e2e" ] && [ -n "$(ls -A tests/e2e/*.py 2>/dev/null)" ]; then
          echo "Found E2E tests, running..."
          pytest tests/e2e/ -v --timeout=300
        elif [ -d "tests/integration" ] && [ -n "$(ls -A tests/integration/*.py 2>/dev/null)" ]; then
          echo "Running integration tests as E2E..."
          pytest tests/integration/ -v --timeout=300 -m "not requires_kafka"
        else
          echo "No E2E or integration tests found - this is expected for new infrastructure"
          echo "E2E job passes as no tests are defined yet"
          exit 0
        fi
    
    - name: Test API endpoints (if backend exists)
      run: |
        if [ -d "backend" ]; then
          echo "Backend directory found, testing would go here..."
          # In a real scenario, start the backend and test endpoints
        fi
        
        if [ -d "portal" ]; then
          echo "Portal directory found, testing would go here..."
          # In a real scenario, build and test the portal
        fi
    
    - name: Collect logs on failure
      if: failure()
      run: |
        echo "Collecting diagnostic information..."
        kubectl get all --all-namespaces || true
        kubectl describe pods --all-namespaces || true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results
        path: |
          test-reports/
          *.log
        retention-days: 30

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [k8s_validate, sbom_and_sign, e2e]
    if: always()
    
    steps:
    - name: Check job status
      run: |
        {
          echo "## Workflow Summary"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| k8s_validate | ${{ needs.k8s_validate.result }} |"
          echo "| sbom_and_sign | ${{ needs.sbom_and_sign.result }} |"
          echo "| e2e | ${{ needs.e2e.result }} |"
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Fail if any job failed
        if [ "${{ needs.k8s_validate.result }}" = "failure" ] || \
           [ "${{ needs.sbom_and_sign.result }}" = "failure" ] || \
           [ "${{ needs.e2e.result }}" = "failure" ]; then
          {
            echo ""
            echo "❌ One or more required checks failed"
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        else
          {
            echo ""
            echo "✅ All required checks passed"
          } >> "$GITHUB_STEP_SUMMARY"
        fi
