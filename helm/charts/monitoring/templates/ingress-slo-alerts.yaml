---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ingress-slo-alerts
  namespace: monitoring
  labels:
    role: slo
    component: ingress
    alertmanager: main
spec:
  groups:
    - name: ingress.slo.latency
      interval: 1m
      rules:
        # Grafana UI
        - alert: IngressLatencyP95HighGrafana
          expr: |
            ingress:http_latency_p95_service:5m{namespace="monitoring",service="grafana"} > 1
          for: 10m
          labels:
            severity: warning
            service: grafana
            slo: ingress-p95
            target: "p95 < 1s"
          annotations:
            summary: "Grafana ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 1s over 5m."

        # DataHub Frontend
        - alert: IngressLatencyP95HighDatahubFrontend
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="datahub-frontend"} > 0.3
          for: 10m
          labels:
            severity: warning
            service: datahub-frontend
            slo: ingress-p95
            target: "p95 < 300ms"
          annotations:
            summary: "DataHub Frontend ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 0.3s over 5m."

        # DataHub GMS (API)
        - alert: IngressLatencyP95HighDatahubGMS
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="datahub-gms"} > 0.3
          for: 10m
          labels:
            severity: warning
            service: datahub-gms
            slo: ingress-p95
            target: "p95 < 300ms"
          annotations:
            summary: "DataHub GMS ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 0.3s over 5m."

        # Trino Coordinator
        - alert: IngressLatencyP95HighTrino
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="trino-coordinator"} > 2
          for: 15m
          labels:
            severity: warning
            service: trino-coordinator
            slo: ingress-p95
            target: "p95 < 2s"
          annotations:
            summary: "Trino ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 2s over 5m."

        # ClickHouse HTTP
        - alert: IngressLatencyP95HighClickHouse
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="clickhouse"} > 2
          for: 15m
          labels:
            severity: warning
            service: clickhouse
            slo: ingress-p95
            target: "p95 < 2s"
          annotations:
            summary: "ClickHouse ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 2s over 5m."

        # Superset
        - alert: IngressLatencyP95HighSuperset
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="superset"} > 2
          for: 10m
          labels:
            severity: warning
            service: superset
            slo: ingress-p95
            target: "p95 < 2s"
          annotations:
            summary: "Superset ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 2s over 5m."

        # MinIO Console
        - alert: IngressLatencyP95HighMinioConsole
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="minio-console"} > 0.5
          for: 10m
          labels:
            severity: warning
            service: minio-console
            slo: ingress-p95
            target: "p95 < 500ms"
          annotations:
            summary: "MinIO Console ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 0.5s over 5m."

        # Vault
        - alert: IngressLatencyP95HighVault
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="vault"} > 0.2
          for: 10m
          labels:
            severity: warning
            service: vault
            slo: ingress-p95
            target: "p95 < 200ms"
          annotations:
            summary: "Vault ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 0.2s over 5m."

        # LakeFS
        - alert: IngressLatencyP95HighLakeFS
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="lakefs"} > 0.25
          for: 10m
          labels:
            severity: warning
            service: lakefs
            slo: ingress-p95
            target: "p95 < 250ms"
          annotations:
            summary: "LakeFS ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 0.25s over 5m."

        # DolphinScheduler API
        - alert: IngressLatencyP95HighDolphin
          expr: |
            ingress:http_latency_p95_service:5m{namespace="data-platform",service="dolphinscheduler-api"} > 0.4
          for: 10m
          labels:
            severity: warning
            service: dolphinscheduler-api
            slo: ingress-p95
            target: "p95 < 400ms"
          annotations:
            summary: "DolphinScheduler ingress p95 latency high"
          description: "p95 {{`{{ $value }}`}}s > 0.4s over 5m."

        # Path-level examples (specific critical paths)
        - alert: IngressLatencyP95HighDatahubAPIPath
          expr: |
            ingress:http_latency_p95:5m{namespace="data-platform",service="datahub-gms",path="/api"} > 0.3
          for: 10m
          labels:
            severity: warning
            service: datahub-gms
            slo: ingress-p95
            target: "p95 < 300ms (path=/api)"
          annotations:
            summary: "DataHub API (/api) ingress p95 latency high"
            description: "p95 {{`{{ $value }}`}}s > 0.3s over 5m (path=/api)."

    - name: ingress.slo.errors
      interval: 1m
      rules:
        - alert: IngressErrorRatioHigh
          expr: |
            ingress:http_error_ratio_service:5m > 0.005
          for: 10m
          labels:
            severity: warning
            slo: ingress-error-rate
            target: "error rate < 0.5%"
          annotations:
            summary: "Ingress error rate high for {{`{{ $labels.service }}`}} ({{`{{ $labels.namespace }}`}})"
            description: "5xx ratio {{`{{ $value | humanizePercentage }}`}} over 5m > 0.5%."
