{{- if .Values.serviceAccount.create -}}
---
# JupyterHub Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "jupyterhub.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
    component: jupyterhub
automountServiceAccountToken: true

---
# JupyterHub RBAC - ClusterRole for Hub
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "jupyterhub.fullname" . }}
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
rules:
  # Core pod operations
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "create", "delete", "patch"]
  
  # Pod logs and status
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  
  - apiGroups: [""]
    resources: ["pods/status"]
    verbs: ["get"]
  
  # Exec into pods
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  
  # Service operations
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch", "create", "delete", "patch"]
  
  # Events
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
  
  # PersistentVolumeClaims
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "delete", "patch"]
  
  # Secrets for credentials
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]
  
  # ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

---
# ClusterRole for User Pods
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "jupyterhub.fullname" . }}-user
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
    component: jupyterhub-user
rules:
  # Read-only access to pods
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  
  # Read logs
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  
  # Read events
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]
  
  # Read PVCs
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for Hub
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "jupyterhub.fullname" . }}
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "jupyterhub.fullname" . }}
subjects:
  - kind: ServiceAccount
    name: {{ include "jupyterhub.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}

---
# ServiceAccount for User Pods
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jupyter-user
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
    component: jupyterhub-user
automountServiceAccountToken: true

---
# ClusterRoleBinding for User Pods
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "jupyterhub.fullname" . }}-user
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "jupyterhub.fullname" . }}-user
subjects:
  - kind: ServiceAccount
    name: jupyter-user
    namespace: {{ .Release.Namespace }}
{{- end }}
