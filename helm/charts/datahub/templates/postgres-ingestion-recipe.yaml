# DataHub Ingestion Recipe for PostgreSQL
# Discovers database schemas, tables, and columns

apiVersion: v1
kind: ConfigMap
metadata:
  name: datahub-postgres-ingestion-recipe
  namespace: data-platform
  labels:
    app: datahub
    component: ingestion
data:
  postgres-recipe.yaml: |
    source:
      type: postgres
      config:
        host_port: "postgres-shared-service.data-platform.svc.cluster.local:5432"
        database: "datahub"
        username: "datahub"
        password: "${POSTGRES_PASSWORD}"
        
        # Schema filtering
        schema_pattern:
          allow:
            - "public"
          deny:
            - "information_schema"
            - "pg_.*"
        
        # Table filtering
        table_pattern:
          allow:
            - ".*"
          deny:
            - "tmp_.*"
            - "staging_.*"
        
        # Include views
        include_views: true
        include_tables: true
        
        # Profiling configuration
        profiling:
          enabled: true
          profile_table_level_only: true
          include_field_null_count: true
          include_field_min_value: true
          include_field_max_value: true
          max_workers: 10
        
        # Lineage extraction
        include_table_lineage: true
        
        # Stateful ingestion
        stateful_ingestion:
          enabled: true
          remove_stale_metadata: true
    
    sink:
      type: datahub-rest
      config:
        server: "http://datahub-gms.data-platform.svc.cluster.local:8080"
        token: "${DATAHUB_SYSTEM_TOKEN}"
    
    pipeline_name: "postgres_metadata_ingestion"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: datahub-postgres-ingestion
  namespace: data-platform
  labels:
    app: datahub-ingestion
    source: postgres
spec:
  schedule: "0 4 * * *"  # Daily at 04:00
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          serviceAccountName: datahub-ingestion
          restartPolicy: Never
          containers:
          - name: datahub-ingestion
            image: acryldata/datahub-ingestion:head
            env:
            - name: DATAHUB_GMS_HOST
              value: "datahub-gms.data-platform.svc.cluster.local"
            - name: DATAHUB_GMS_PORT
              value: "8080"
            - name: DATAHUB_SYSTEM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: datahub-secret
                  key: DATAHUB_SECRET
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-shared-secret
                  key: password
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting PostgreSQL metadata ingestion..."
              datahub ingest -c /config/postgres-recipe.yaml
              echo "Ingestion complete"
            volumeMounts:
            - name: recipe
              mountPath: /config
              readOnly: true
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 500m
                memory: 1Gi
          volumes:
          - name: recipe
            configMap:
              name: datahub-postgres-ingestion-recipe

