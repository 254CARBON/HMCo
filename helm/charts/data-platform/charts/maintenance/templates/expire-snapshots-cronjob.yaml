apiVersion: batch/v1
kind: CronJob
metadata:
  name: iceberg-expire-snapshots
  namespace: data-platform
  labels:
    app: iceberg-maintenance
    component: expire-snapshots
spec:
  schedule: {{ .Values.schedules.expireSnapshots | quote }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: iceberg-maintenance
            component: expire-snapshots
        spec:
          restartPolicy: OnFailure
          containers:
          - name: expire-snapshots
            image: "{{ .Values.spark.image.repository }}:{{ .Values.spark.image.tag }}"
            command:
            - /bin/sh
            - -c
            - |
              spark-sql \
                --conf spark.sql.catalog.iceberg=org.apache.iceberg.spark.SparkCatalog \
                --conf spark.sql.catalog.iceberg.type=rest \
                --conf spark.sql.catalog.iceberg.uri={{ .Values.iceberg.catalogUri }} \
                --conf spark.sql.catalog.iceberg.warehouse={{ .Values.iceberg.warehouse }} \
                --conf spark.sql.catalog.iceberg.io-impl=org.apache.iceberg.aws.s3.S3FileIO \
                --conf spark.sql.catalog.iceberg.s3.endpoint={{ .Values.s3.endpoint }} \
                --conf spark.sql.catalog.iceberg.s3.path-style-access={{ .Values.s3.pathStyleAccess }} \
                -e "
                -- Expire old snapshots (keep last 10, older than 30 days)
                CALL iceberg.system.expire_snapshots(
                  table => 'hub_curated.eia_daily_fuel',
                  older_than => TIMESTAMP '$(date -d '30 days ago' '+%Y-%m-%d %H:%M:%S')',
                  retain_last => 10
                );
                
                CALL iceberg.system.expire_snapshots(
                  table => 'hub_curated.iso_rt_lmp',
                  older_than => TIMESTAMP '$(date -d '30 days ago' '+%Y-%m-%d %H:%M:%S')',
                  retain_last => 10
                );
                
                CALL iceberg.system.expire_snapshots(
                  table => 'hub_curated.noaa_hourly',
                  older_than => TIMESTAMP '$(date -d '30 days ago' '+%Y-%m-%d %H:%M:%S')',
                  retain_last => 10
                );
                
                CALL iceberg.system.expire_snapshots(
                  table => 'hub_curated.fred_daily',
                  older_than => TIMESTAMP '$(date -d '30 days ago' '+%Y-%m-%d %H:%M:%S')',
                  retain_last => 10
                );
                "
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.s3.secretName }}
                  key: accesskey
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.s3.secretName }}
                  key: secretkey
            resources:
              {{- toYaml .Values.resources | nindent 14 }}
