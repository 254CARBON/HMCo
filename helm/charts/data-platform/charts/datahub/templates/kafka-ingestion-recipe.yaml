# DataHub Ingestion Recipe for Kafka
# Discovers Kafka topics and their schemas
{{- $kafkaVals := default (dict) .Values.kafka }}
{{- $kafkaBootstrap := default "kafka-service:9092" (get $kafkaVals "bootstrapServers") }}
{{- $schemaRegistryUrl := default "http://schema-registry-service:8081" (get $kafkaVals "schemaRegistryUrl") }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: datahub-kafka-ingestion-recipe
  namespace: data-platform
  labels:
    app: datahub
    component: ingestion
data:
  kafka-recipe.yaml: |
    source:
      type: kafka
      config:
        connection:
          bootstrap: {{ $kafkaBootstrap | quote }}
          schema_registry_url: {{ $schemaRegistryUrl | quote }}
        
        # Topic filtering
        topic_patterns:
          allow:
            - ".*"
          deny:
            - "__.*"  # Skip internal topics
            - "connect-.*"
            - "_schemas"
        
        # Schema extraction
        schema_registry_config:
          schema_registry_class: "datahub.ingestion.source.schema_inference.kafka.KafkaSchemaRegistryProducer"
        
        # Additional metadata
        domain:
          "urn:li:domain:messaging": {}
    
    sink:
      type: datahub-rest
      config:
        server: "http://datahub-gms.data-platform.svc.cluster.local:8080"
        token: "${DATAHUB_SYSTEM_TOKEN}"
    
    pipeline_name: "kafka_metadata_ingestion"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: datahub-kafka-ingestion
  namespace: data-platform
  labels:
    app: datahub-ingestion
    source: kafka
spec:
  schedule: "30 */4 * * *"  # Every 4 hours at :30
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          serviceAccountName: datahub-ingestion
          restartPolicy: Never
          containers:
          - name: datahub-ingestion
            image: acryldata/datahub-ingestion:head
            env:
            - name: DATAHUB_GMS_HOST
              value: "datahub-gms.data-platform.svc.cluster.local"
            - name: DATAHUB_GMS_PORT
              value: "8080"
            - name: DATAHUB_SYSTEM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: datahub-secret
                  key: DATAHUB_SECRET
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting Kafka metadata ingestion..."
              datahub ingest -c /config/kafka-recipe.yaml
              echo "Ingestion complete"
            volumeMounts:
            - name: recipe
              mountPath: /config
              readOnly: true
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 500m
                memory: 1Gi
          volumes:
          - name: recipe
            configMap:
              name: datahub-kafka-ingestion-recipe
