# DataHub Ingestion Recipe for Trino
# This configures automated metadata ingestion from Trino into DataHub

apiVersion: v1
kind: ConfigMap
metadata:
  name: datahub-trino-ingestion-recipe
  namespace: data-platform
  labels:
    app: datahub
    component: ingestion
data:
  trino-recipe.yaml: |
    source:
      type: trino
      config:
        host_port: "trino-coordinator.data-platform.svc.cluster.local:8080"
        username: "datahub"
        # Using default catalog and schema
        catalog: "iceberg"
        schema_pattern:
          allow:
            - "^data_.*"
            - "^analytics_.*"
            - "^warehouse_.*"
        table_pattern:
          allow:
            - ".*"
        # Enable lineage extraction
        include_views: true
        include_tables: true
        # Profiling configuration
        profiling:
          enabled: true
          profile_table_level_only: true
          max_workers: 20
        # Stateful ingestion
        stateful_ingestion:
          enabled: true
          remove_stale_metadata: true
    
    sink:
      type: datahub-rest
      config:
        server: "http://datahub-gms.data-platform.svc.cluster.local:8080"
        # Use system auth token
        token: "${DATAHUB_SYSTEM_TOKEN}"
    
    # Pipeline configuration
    pipeline_name: "trino_metadata_ingestion"
    run_id: "trino-$(date +%Y%m%d-%H%M%S)"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: datahub-trino-ingestion
  namespace: data-platform
  labels:
    app: datahub-ingestion
    source: trino
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          serviceAccountName: datahub-ingestion
          restartPolicy: Never
          containers:
          - name: datahub-ingestion
            image: acryldata/datahub-ingestion:head
            env:
            - name: DATAHUB_GMS_HOST
              value: "datahub-gms.data-platform.svc.cluster.local"
            - name: DATAHUB_GMS_PORT
              value: "8080"
            - name: DATAHUB_SYSTEM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: datahub-secret
                  key: DATAHUB_SECRET
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting Trino metadata ingestion..."
              datahub ingest -c /config/trino-recipe.yaml
              echo "Ingestion complete"
            volumeMounts:
            - name: recipe
              mountPath: /config
              readOnly: true
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 500m
                memory: 1Gi
          volumes:
          - name: recipe
            configMap:
              name: datahub-trino-ingestion-recipe

