---
# Data Lifecycle Policies for MinIO Buckets
# Automates data retention, archival, and cleanup

apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-lifecycle-policies
  namespace: data-platform
  labels:
    app: minio
    component: lifecycle
data:
  raw-lifecycle.json: |
    {
      "Rules": [
        {
          "ID": "raw-expiration",
          "Status": "Enabled",
          "Expiration": {
            "Days": 30
          },
          "Filter": {
            "Prefix": ""
          }
        }
      ]
    }
  
  staged-lifecycle.json: |
    {
      "Rules": [
        {
          "ID": "staged-expiration",
          "Status": "Enabled",
          "Expiration": {
            "Days": 365
          },
          "Filter": {
            "Prefix": ""
          }
        }
      ]
    }
  
  curated-lifecycle.json: |
    {
      "Rules": [
        {
          "ID": "curated-expiration",
          "Status": "Enabled",
          "Expiration": {
            "Days": 1825
          },
          "Filter": {
            "Prefix": ""
          }
        },
        {
          "ID": "noaa-indefinite",
          "Status": "Enabled",
          "Filter": {
            "Prefix": "noaa/"
          }
        },
        {
          "ID": "census-indefinite",
          "Status": "Enabled",
          "Filter": {
            "Prefix": "census/"
          }
        }
      ]
    }
  
  ml-lifecycle.json: |
    {
      "Rules": [
        {
          "ID": "ml-artifacts-expiration",
          "Status": "Enabled",
          "Expiration": {
            "Days": 365
          },
          "Filter": {
            "Prefix": ""
          }
        }
      ]
    }

---
# Iceberg Table Lifecycle Policies ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: iceberg-lifecycle-policies
  namespace: data-platform
  labels:
    app: iceberg
data:
  lifecycle-policy.sql: |
    -- Data retention policies for energy market data
    
    -- Raw/landing: 30 days
    -- Staged/bronze: 12 months  
    -- Curated/silver+gold: 5 years
    -- NOAA hindcast & census static: indefinite
    
    -- Energy prices: Keep 5 years
    ALTER TABLE hub_curated.energy_prices
    SET TBLPROPERTIES (
      'write.metadata.delete-after-commit.enabled' = 'true',
      'write.metadata.previous-versions-max' = '10',
      'write.data.path' = 's3a://hmco-curated/energy_prices/data',
      'write.metadata.path' = 's3a://hmco-curated/energy_prices/metadata',
      'write.parquet.compression-codec' = 'zstd',
      'write.target-file-size-bytes' = '536870912'  -- 512MB files
    );
    
    -- ISO RT LMP: 5-year retention
    ALTER TABLE hub_curated.iso_rt_lmp
    SET TBLPROPERTIES (
      'write.metadata.previous-versions-max' = '20',
      'write.target-file-size-bytes' = '268435456'  -- 256MB
    );
    
    -- NOAA data: Retain indefinitely
    ALTER TABLE hub_curated.noaa_hindcast
    SET TBLPROPERTIES (
      'write.metadata.previous-versions-max' = '100',
      'write.object-storage.enabled' = 'true'
    );
    
    -- Census data: Retain indefinitely
    ALTER TABLE hub_curated.census_static
    SET TBLPROPERTIES (
      'write.metadata.previous-versions-max' = '100',
      'write.object-storage.enabled' = 'true'
    );

---
# Iceberg Compaction CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: iceberg-compaction
  namespace: data-platform
  labels:
    app: iceberg
    component: maintenance
spec:
  schedule: "0 3 * * 0"  # Weekly on Sunday 3 AM
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: "false"
          labels:
            sidecar.istio.io/inject: "false"
        spec:
          restartPolicy: OnFailure
          containers:
          - name: compaction
            image: trinodb/trino:438
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting Iceberg table compaction..."
              
              # Compact energy_prices table
              trino --execute "
              ALTER TABLE iceberg_catalog.commodity_data.energy_prices
              EXECUTE optimize(file_size_threshold => '10MB');
              "
              
              # Compact market_data table
              trino --execute "
              ALTER TABLE iceberg_catalog.commodity_data.market_data
              EXECUTE optimize(file_size_threshold => '10MB');
              "
              
              # Remove old snapshots
              trino --execute "
              ALTER TABLE iceberg_catalog.commodity_data.energy_prices
              EXECUTE expire_snapshots(older_than => TIMESTAMP '2025-01-01 00:00:00', retain_last => 10);
              "
              
              echo "Compaction complete!"
            resources:
              requests:
                cpu: 2000m
                memory: 4Gi
              limits:
                cpu: 4000m
                memory: 8Gi

---
# Data Archival Policy CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: data-archival
  namespace: data-platform
  labels:
    app: iceberg
    component: archival
spec:
  schedule: "0 2 1 * *"  # Monthly on 1st at 2 AM
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: "false"
          labels:
            sidecar.istio.io/inject: "false"
        spec:
          restartPolicy: OnFailure
          containers:
          - name: archival
            image: trinodb/trino:438
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting data archival..."
              
              # Archive data older than 2 years to cold storage
              trino --execute "
              CREATE TABLE IF NOT EXISTS iceberg_catalog.commodity_data.energy_prices_archive
              AS SELECT * FROM iceberg_catalog.commodity_data.energy_prices
              WHERE price_date < CURRENT_DATE - INTERVAL '2' YEAR;
              "
              
              # Delete archived data from hot table
              trino --execute "
              DELETE FROM iceberg_catalog.commodity_data.energy_prices
              WHERE price_date < CURRENT_DATE - INTERVAL '2' YEAR;
              "
              
              echo "Archival complete!"
            resources:
              requests:
                cpu: 4000m
                memory: 8Gi
              limits:
                cpu: 8000m
                memory: 16Gi


