apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: experiments.kubeflow.org
spec:
  group: kubeflow.org
  versions:
  - name: v1beta1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              algorithm:
                type: object
              objective:
                type: object
              parameters:
                type: array
                items:
                  type: object
              parallelTrialCount:
                type: integer
              maxTrialCount:
                type: integer
              maxFailedTrialCount:
                type: integer
  scope: Namespaced
  names:
    kind: Experiment
    plural: experiments
    singular: experiment
    shortNames:
    - exp
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: katib-controller
  namespace: kubeflow
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: katib-controller
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["apps"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["batch"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["kubeflow.org"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: katib-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: katib-controller
subjects:
- kind: ServiceAccount
  name: katib-controller
  namespace: kubeflow
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: katib-config
  namespace: kubeflow
data:
  config.yaml: |
    runtime:
      suggestions:
      - algorithmName: random
        image: docker.io/kubeflowkatib/suggestion-hyperopt:v0.16.0
      - algorithmName: tpe
        image: docker.io/kubeflowkatib/suggestion-hyperopt:v0.16.0
      - algorithmName: grid
        image: docker.io/kubeflowkatib/suggestion-chocolate:v0.16.0
      - algorithmName: hyperband
        image: docker.io/kubeflowkatib/suggestion-hyperband:v0.16.0
      - algorithmName: bayesianoptimization
        image: docker.io/kubeflowkatib/suggestion-skopt:v0.16.0
      - algorithmName: cmaes
        image: docker.io/kubeflowkatib/suggestion-goptuna:v0.16.0
      - algorithmName: sobol
        image: docker.io/kubeflowkatib/suggestion-goptuna:v0.16.0
      metricsCollectors:
      - kind: StdOut
        image: docker.io/kubeflowkatib/file-metrics-collector:v0.16.0
      - kind: File
        image: docker.io/kubeflowkatib/file-metrics-collector:v0.16.0
      - kind: TensorFlowEvent
        image: docker.io/kubeflowkatib/tfevent-metrics-collector:v0.16.0
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: katib-controller
  namespace: kubeflow
  labels:
    app: katib-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: katib-controller
  template:
    metadata:
      labels:
        app: katib-controller
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
      serviceAccountName: katib-controller
      containers:
      - name: katib-controller
        image: docker.io/kubeflowkatib/katib-controller:v0.16.0
        command:
        - ./katib-controller
        ports:
        - containerPort: 8443
          name: webhook
          protocol: TCP
        - containerPort: 8080
          name: metrics
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            - NET_RAW
          readOnlyRootFilesystem: true
        env:
        - name: KATIB_CORE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
        volumeMounts:
        - name: katib-config
          mountPath: /opt/katib
        - name: webhook-cert
          mountPath: /tmp/cert
          readOnly: true
      volumes:
      - name: katib-config
        configMap:
          name: katib-config
      - name: webhook-cert
        secret:
          secretName: katib-webhook-cert
---
apiVersion: v1
kind: Service
metadata:
  name: katib-controller
  namespace: kubeflow
  labels:
    app: katib-controller
spec:
  selector:
    app: katib-controller
  ports:
  - name: webhook
    port: 443
    targetPort: 8443
  - name: metrics
    port: 8080
    targetPort: 8080
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: katib-webhook-cert
  namespace: kubeflow
spec:
  secretName: katib-webhook-cert
  dnsNames:
  - katib-controller
  - katib-controller.kubeflow
  - katib-controller.kubeflow.svc
  - katib-controller.kubeflow.svc.cluster.local
  issuerRef:
    name: selfsigned
    kind: ClusterIssuer
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: katib-mutating-webhook
  labels:
    app: katib-controller
  annotations:
    cert-manager.io/inject-ca-from: kubeflow/katib-webhook-cert
webhooks:
  - name: defaulter.experiment.katib.kubeflow.org
    admissionReviewVersions:
    - v1
    sideEffects: None
    failurePolicy: Fail
    clientConfig:
      service:
        name: katib-controller
        namespace: kubeflow
        path: /mutate-experiment
    rules:
    - apiGroups:
      - kubeflow.org
      apiVersions:
      - v1beta1
      operations:
      - CREATE
      - UPDATE
      resources:
      - experiments
  - name: mutator.pod.katib.kubeflow.org
    admissionReviewVersions:
    - v1
    sideEffects: None
    failurePolicy: Fail
    clientConfig:
      service:
        name: katib-controller
        namespace: kubeflow
        path: /mutate-pod
    namespaceSelector:
      matchLabels:
        katib.kubeflow.org/metrics-collector-injection: enabled
    objectSelector:
      matchExpressions:
      - key: katib.kubeflow.org/metrics-collector-injection
        operator: NotIn
        values:
        - disabled
    rules:
    - apiGroups:
      - ""
      apiVersions:
      - v1
      operations:
      - CREATE
      resources:
      - pods
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: katib-validating-webhook
  labels:
    app: katib-controller
  annotations:
    cert-manager.io/inject-ca-from: kubeflow/katib-webhook-cert
webhooks:
  - name: validator.experiment.katib.kubeflow.org
    admissionReviewVersions:
    - v1
    sideEffects: None
    failurePolicy: Fail
    clientConfig:
      service:
        name: katib-controller
        namespace: kubeflow
        path: /validate-experiment
    rules:
    - apiGroups:
      - kubeflow.org
      apiVersions:
      - v1beta1
      operations:
      - CREATE
      - UPDATE
      resources:
      - experiments
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: katib-db-manager
  namespace: kubeflow
  labels:
    app: katib-db-manager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: katib-db-manager
  template:
    metadata:
      labels:
        app: katib-db-manager
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
      containers:
      - name: katib-db-manager
        image: docker.io/kubeflowkatib/katib-db-manager:v0.16.0
        ports:
        - containerPort: 6789
          name: api
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            - NET_RAW
          readOnlyRootFilesystem: true
        env:
        - name: DB_NAME
          value: "mysql"
        - name: DB_USER
          value: "root"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: katib-mysql-secret
              key: mysql-root-password
        - name: DB_HOST
          value: "katib-mysql.kubeflow.svc.cluster.local"
        - name: DB_PORT
          value: "3306"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: katib-db-manager
  namespace: kubeflow
  labels:
    app: katib-db-manager
spec:
  type: ClusterIP
  selector:
    app: katib-db-manager
  ports:
  - name: api
    port: 6789
    targetPort: 6789
    protocol: TCP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: katib-ui
  namespace: kubeflow
  labels:
    app: katib-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: katib-ui
  template:
    metadata:
      labels:
        app: katib-ui
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      containers:
      - name: katib-ui
        image: docker.io/kubeflowkatib/katib-ui:v0.16.0
        ports:
        - containerPort: 8080
          name: http
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: katib-ui
  namespace: kubeflow
  labels:
    app: katib-ui
spec:
  type: ClusterIP
  selector:
    app: katib-ui
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: katib-controller
  namespace: kubeflow
  labels:
    app: katib-controller
spec:
  selector:
    matchLabels:
      app: katib-controller
  endpoints:
  - port: metrics
    path: /metrics
    interval: 30s
