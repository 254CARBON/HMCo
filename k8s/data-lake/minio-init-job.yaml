---
# MinIO bucket initialization job
# This job creates required S3 buckets for Iceberg, SeaTunnel, and DataHub
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init-buckets
  namespace: data-platform
  labels:
    app: minio
    component: storage
spec:
  backoffLimit: 3
  completions: 1
  parallelism: 1
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: minio-init
        image: minio/mc:latest
        env:
        - name: MC_HOST_minio
          value: "http://minioadmin:minioadmin123@minio-service:9000"
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "Waiting for MinIO to be ready..."
          until mc alias list minio > /dev/null 2>&1; do
            echo "Waiting for MinIO connection..."
            sleep 2
          done
          
          echo "MinIO is ready!"
          
          # Create required buckets
          echo "Creating bucket: iceberg-warehouse"
          mc mb --ignore-existing minio/iceberg-warehouse
          
          echo "Creating bucket: seatunnel-output"
          mc mb --ignore-existing minio/seatunnel-output
          
          echo "Creating bucket: datahub-storage"
          mc mb --ignore-existing minio/datahub-storage
          
          echo "Creating bucket: lakefs-data"
          mc mb --ignore-existing minio/lakefs-data
          
          # Set bucket policies for public access (optional)
          echo "Setting bucket policies..."
          
          # Allow read access to iceberg-warehouse
          mc policy set public minio/iceberg-warehouse || true
          
          # Allow read access to seatunnel-output  
          mc policy set public minio/seatunnel-output || true
          
          echo "All buckets initialized successfully!"
          echo ""
          echo "Bucket summary:"
          mc ls minio/
        resources:
          limits:
            memory: "256Mi"
            cpu: "250m"
          requests:
            memory: "128Mi"
            cpu: "100m"
      serviceAccountName: default
