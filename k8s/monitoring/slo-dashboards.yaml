---
# SLO/SLI Dashboards and Alerts
# Service Level Objectives and Indicators

apiVersion: v1
kind: ConfigMap
metadata:
  name: slo-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  slo-dashboard.json: |
    {
      "dashboard": {
        "title": "Service Level Objectives (SLOs)",
        "tags": ["slo", "sli", "reliability"],
        "timezone": "UTC",
        "panels": [
          {
            "title": "Platform Availability SLO (99.9%)",
            "targets": [
              {
                "expr": "avg_over_time(up{job=\"kubernetes-pods\"}[5m]) * 100",
                "legendFormat": "Availability %"
              }
            ],
            "thresholds": [
              { "value": 99.9, "color": "green" },
              { "value": 99.0, "color": "yellow" },
              { "value": 95.0, "color": "red" }
            ]
          },
          {
            "title": "API Response Time SLO (p95 < 200ms)",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) * 1000",
                "legendFormat": "P95 Response Time (ms)"
              }
            ]
          },
          {
            "title": "Error Rate SLO (< 1%)",
            "targets": [
              {
                "expr": "(sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m]))) * 100",
                "legendFormat": "Error Rate %"
              }
            ]
          },
          {
            "title": "Data Freshness SLO (< 5 minutes)",
            "targets": [
              {
                "expr": "(time() - datahub_last_ingestion_timestamp) / 60",
                "legendFormat": "Minutes since last ingestion"
              }
            ]
          },
          {
            "title": "Query Performance SLO (p95 < 5s)",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(trino_query_execution_time_seconds_bucket[5m]))",
                "legendFormat": "P95 Query Time (s)"
              }
            ]
          }
        ]
      }
    }

---
# SLO Alert Rules
apiVersion: v1
kind: ConfigMap
metadata:
  name: slo-alert-rules
  namespace: monitoring
data:
  slo-rules.yaml: |
    groups:
    - name: slo_alerts
      interval: 30s
      rules:
      # Availability SLO
      - alert: AvailabilitySLOViolation
        expr: avg_over_time(up{job="kubernetes-pods"}[5m]) < 0.999
        for: 5m
        labels:
          severity: critical
          slo: availability
        annotations:
          summary: "Platform availability below 99.9% SLO"
          description: "Current availability: {{ $value | humanizePercentage }}"
      
      # Response Time SLO
      - alert: ResponseTimeSLOViolation
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
          slo: latency
        annotations:
          summary: "API response time above 200ms SLO (p95)"
          description: "Current p95: {{ $value | humanizeDuration }}"
      
      # Error Rate SLO
      - alert: ErrorRateSLOViolation
        expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) > 0.01
        for: 5m
        labels:
          severity: critical
          slo: error_rate
        annotations:
          summary: "Error rate above 1% SLO"
          description: "Current error rate: {{ $value | humanizePercentage }}"
      
      # Data Freshness SLO
      - alert: DataFreshnessSLOViolation
        expr: (time() - datahub_last_ingestion_timestamp) / 60 > 5
        for: 10m
        labels:
          severity: warning
          slo: data_freshness
        annotations:
          summary: "Data ingestion delayed beyond 5 minute SLO"
          description: "Minutes since last ingestion: {{ $value | humanize }}"
      
      # Query Performance SLO
      - alert: QueryPerformanceSLOViolation
        expr: histogram_quantile(0.95, rate(trino_query_execution_time_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
          slo: query_performance
        annotations:
          summary: "Query p95 latency above 5 second SLO"
          description: "Current p95: {{ $value | humanizeDuration }}"
      
      # GPU Utilization SLO
      - alert: GPUUtilizationBelowTarget
        expr: nvidia_gpu_duty_cycle < 80
        for: 30m
        labels:
          severity: info
          slo: gpu_utilization
        annotations:
          summary: "GPU utilization below 80% target"
          description: "Current utilization: {{ $value }}%"
      
      # Storage SLO
      - alert: StorageCapacitySLOWarning
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) > 0.85
        for: 15m
        labels:
          severity: warning
          slo: storage
        annotations:
          summary: "Storage usage above 85%"
          description: "Current usage: {{ $value | humanizePercentage }}"


