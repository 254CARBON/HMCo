---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: slo-alerts
  namespace: monitoring
  labels:
    role: slo
spec:
  groups:
    - name: slo.burnrate
      interval: 1m
      rules:
        # SLO: 99.9% availability (error budget 0.001)
        # Critical: fast burn 2h/6h
        - alert: SLOHighErrorBudgetBurn
          expr: |
            (sli:http_error_ratio:2h > (0.001 * 14.4))
            and on (job)
            (sli:http_error_ratio:6h > (0.001 * 6))
          for: 10m
          labels:
            severity: critical
            slo: http-availability
            target: "99.9%"
          annotations:
            summary: "High error-budget burn (critical) for {{ $labels.job }}"
            description: |
              Error ratio exceeds fast-burn thresholds.
              2h > 14.4x and 6h > 6x of budget (SLO 99.9%).

        # Warning: slow burn 24h/3d
        - alert: SLOErrorBudgetBurnWarning
          expr: |
            (sli:http_error_ratio:24h > (0.001 * 3))
            and on (job)
            (sli:http_error_ratio:3d > (0.001 * 1))
          for: 30m
          labels:
            severity: warning
            slo: http-availability
            target: "99.9%"
          annotations:
            summary: "Error-budget burn (warning) for {{ $labels.job }}"
            description: |
              Error ratio exceeds slow-burn thresholds.
              24h > 3x and 3d > 1x of budget (SLO 99.9%).

    - name: slo.latency
      interval: 1m
      rules:
        - alert: LatencyP95High
          expr: sli:http_latency_p95:5m > 0.5
          for: 10m
          labels:
            severity: warning
            slo: http-latency
            target: "p95 < 500ms"
          annotations:
            summary: "High p95 latency for {{ $labels.job }}"
            description: "p95 latency {{ $value }}s > 0.5s over 5m. Tune per-service thresholds as needed."

    - name: slo.availability
      interval: 1m
      rules:
        - alert: AvailabilityLow
          expr: sli:service_availability:5m < 0.995
          for: 10m
          labels:
            severity: warning
            slo: availability
            target: "> 99.5% (rolling 5m)"
          annotations:
            summary: "Availability low for {{ $labels.job }}"
            description: "Service availability over last 5m dropped below 99.5%."

