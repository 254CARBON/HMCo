# SeaTunnel Job: MySQL to Iceberg (CDC)
# Change Data Capture from MySQL to Iceberg using CDC

env {
  execution.parallelism = 2
  job.mode = "STREAMING"
  checkpoint.interval = 60000
}

source {
  MySQL-CDC {
    hostname = "mysql-seatunnel-service"
    port = 3306
    username = "root"
    password = "root_password"
    database-names = ["seatunnel"]
    table-names = ["seatunnel.customers"]
    result_table_name = "mysql_cdc_data"
    
    # CDC configuration
    server-id = 5400
    server-time-zone = "UTC"
    startup.mode = "latest-offset"
    include-schema-change-events = true
    
    schema = {
      fields {
        id = "int"
        name = "string"
        email = "string"
        phone = "string"
        created_at = "timestamp"
        updated_at = "timestamp"
      }
    }
  }
}

sink {
  Iceberg {
    catalog_name = "rest"
    catalog_type = "rest"
    warehouse = "s3://iceberg-warehouse/"
    uri = "http://iceberg-rest-catalog:8181"
    database = "ods"
    table = "customers_cdc"
    
    # S3/MinIO configuration
    s3.access-key-id = "minioadmin"
    s3.secret-access-key = "minioadmin123"
    s3.region = "us-east-1"
    s3.endpoint = "http://minio-service:9000"
    
    # Iceberg table configuration
    partition_by = ["year(updated_at)", "month(updated_at)"]
    
    # Write options
    write_format = "parquet"
    compression_codec = "zstd"
    
    # Schema matching source
    schema = {
      fields {
        id = "int"
        name = "string"
        email = "string"
        phone = "string"
        created_at = "timestamp"
        updated_at = "timestamp"
      }
    }
  }
}
