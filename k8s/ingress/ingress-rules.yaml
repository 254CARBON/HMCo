# Ingress rules for data platform services
# This file contains the ingress configurations for all deployed services

---
# DataHub Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: datahub-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access SSO
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_email $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_groups $upstream_http_cf_access_groups;
      proxy_set_header X-WEBAUTH-USER $cf_email;
      proxy_set_header X-WEBAUTH-EMAIL $cf_email;
      proxy_set_header X-WEBAUTH-GROUPS $cf_groups;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "datahub"
    portal.254carbon.com/service-name: "DataHub"
    portal.254carbon.com/service-category: "Data Catalog"
    portal.254carbon.com/service-description: "Metadata platform for data discovery and lineage."
    portal.254carbon.com/service-icon: "üìä"
    portal.254carbon.com/service-health-path: "/api/health"
    portal.254carbon.com/use-cloudflare-access: "true"
    portal.254carbon.com/cf-access-secret-name: "cf-access-datahub"
    portal.254carbon.com/cf-access-secret-namespace: "data-platform"
    portal.254carbon.com/cf-access-client-id-key: "client_id"
    portal.254carbon.com/cf-access-client-secret-key: "client_secret"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - datahub.254carbon.com
    secretName: datahub-tls
  rules:
  - host: datahub.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: datahub-frontend
            port:
              number: 9002
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: datahub-gms
            port:
              number: 8080
  - host: datahub.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: datahub-frontend
            port:
              number: 9002
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: datahub-gms
            port:
              number: 8080

---
# Superset Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: superset-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access SSO
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_email $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_groups $upstream_http_cf_access_groups;
      proxy_set_header X-WEBAUTH-USER $cf_email;
      proxy_set_header X-WEBAUTH-EMAIL $cf_email;
      proxy_set_header X-WEBAUTH-GROUPS $cf_groups;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "superset"
    portal.254carbon.com/service-name: "Superset"
    portal.254carbon.com/service-category: "Visualization"
    portal.254carbon.com/service-description: "Data visualization and BI platform."
    portal.254carbon.com/service-icon: "üìâ"
    portal.254carbon.com/service-health-path: "/api/v1/health"
    portal.254carbon.com/use-cloudflare-access: "false"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - superset.254carbon.com
    secretName: superset-tls
  rules:
  - host: superset.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: superset
            port:
              number: 8088
  - host: superset.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: superset
            port:
              number: 8088

---
# Grafana Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access SSO
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_email $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_groups $upstream_http_cf_access_groups;
      proxy_set_header X-WEBAUTH-USER $cf_email;
      proxy_set_header X-WEBAUTH-EMAIL $cf_email;
      proxy_set_header X-WEBAUTH-GROUPS $cf_groups;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "grafana"
    portal.254carbon.com/service-name: "Grafana"
    portal.254carbon.com/service-category: "Monitoring"
    portal.254carbon.com/service-description: "Observability dashboards and alerts."
    portal.254carbon.com/service-icon: "üìà"
    portal.254carbon.com/service-health-path: "/api/health"
    portal.254carbon.com/use-cloudflare-access: "false"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - grafana.254carbon.com
    secretName: grafana-tls
  rules:
  - host: grafana.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
  - host: grafana.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000

---
# Apache Doris Ingress (Frontend)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: doris-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access SSO
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_email $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_groups $upstream_http_cf_access_groups;
      proxy_set_header X-WEBAUTH-USER $cf_email;
      proxy_set_header X-WEBAUTH-EMAIL $cf_email;
      proxy_set_header X-WEBAUTH-GROUPS $cf_groups;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "doris"
    portal.254carbon.com/service-name: "Apache Doris"
    portal.254carbon.com/service-category: "Analytics"
    portal.254carbon.com/service-description: "OLAP database for real-time analytics."
    portal.254carbon.com/service-icon: "‚ö°"
    portal.254carbon.com/use-cloudflare-access: "false"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - doris.254carbon.com
    secretName: doris-tls
  rules:
  - host: doris.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: doris-fe-service
            port:
              number: 8030
  - host: doris.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: doris-fe-service
            port:
              number: 8030

---
# Trino Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: trino-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "trino"
    portal.254carbon.com/service-name: "Trino"
    portal.254carbon.com/service-category: "Query Engine"
    portal.254carbon.com/service-description: "Distributed SQL query engine."
    portal.254carbon.com/service-icon: "üîç"
    portal.254carbon.com/use-cloudflare-access: "false"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - trino.254carbon.com
    secretName: trino-tls
  rules:
  - host: trino.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: trino-coordinator
            port:
              number: 8080
  - host: trino.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: trino-coordinator
            port:
              number: 8080

---
# Vault Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vault-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Vault specific configuration
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    # Cloudflare Access Authentication
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$scheme://$host$request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_access_user $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_access_groups $upstream_http_cf_access_groups;
      proxy_set_header CF-Access-Authenticated-User-Email $cf_access_user;
      proxy_set_header X-FORWARDED-USER $cf_access_user;
      proxy_set_header X-WEBAUTH-EMAIL $cf_access_user;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "vault"
    portal.254carbon.com/service-name: "Vault"
    portal.254carbon.com/service-category: "Security"
    portal.254carbon.com/service-description: "Secrets management and encryption."
    portal.254carbon.com/service-icon: "üîê"
    portal.254carbon.com/use-cloudflare-access: "true"
    portal.254carbon.com/cf-access-secret-name: "cf-access-vault"
    portal.254carbon.com/cf-access-secret-namespace: "data-platform"
    portal.254carbon.com/cf-access-client-id-key: "client_id"
    portal.254carbon.com/cf-access-client-secret-key: "client_secret"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - vault.254carbon.com
    secretName: vault-tls
  rules:
  - host: vault.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: vault
            port:
              number: 8200
  - host: vault.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: vault
            port:
              number: 8200

---
# lakeFS Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: lakefs-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access SSO
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_email $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_groups $upstream_http_cf_access_groups;
      proxy_set_header X-WEBAUTH-USER $cf_email;
      proxy_set_header X-WEBAUTH-EMAIL $cf_email;
      proxy_set_header X-WEBAUTH-GROUPS $cf_groups;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "lakefs"
    portal.254carbon.com/service-name: "LakeFS"
    portal.254carbon.com/service-category: "Data Versioning"
    portal.254carbon.com/service-description: "Version control for data lakes."
    portal.254carbon.com/service-icon: "üóÇÔ∏è"
    portal.254carbon.com/use-cloudflare-access: "false"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - lakefs.254carbon.com
    secretName: lakefs-tls
  rules:
  - host: lakefs.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: lakefs
            port:
              number: 8000
  - host: lakefs.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: lakefs
            port:
              number: 8000

---
# DolphinScheduler Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dolphinscheduler-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access Authentication
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$scheme://$host$request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_access_user $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_access_groups $upstream_http_cf_access_groups;
      proxy_set_header CF-Access-Authenticated-User-Email $cf_access_user;
      proxy_set_header X-FORWARDED-USER $cf_access_user;
      proxy_set_header X-WEBAUTH-EMAIL $cf_access_user;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "dolphin"
    portal.254carbon.com/service-name: "DolphinScheduler"
    portal.254carbon.com/service-category: "Orchestration"
    portal.254carbon.com/service-description: "Workflow orchestration platform."
    portal.254carbon.com/service-icon: "üê¨"
    portal.254carbon.com/use-cloudflare-access: "true"
    portal.254carbon.com/cf-access-secret-name: "cf-access-dolphin"
    portal.254carbon.com/cf-access-secret-namespace: "data-platform"
    portal.254carbon.com/cf-access-client-id-key: "client_id"
    portal.254carbon.com/cf-access-client-secret-key: "client_secret"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - dolphin.254carbon.com
    - dolphinscheduler.127.0.0.1.nip.io
    secretName: dolphinscheduler-tls
  rules:
  - host: dolphin.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dolphinscheduler-api
            port:
              number: 12345
  - host: dolphinscheduler.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dolphinscheduler-api
            port:
              number: 12345
  - host: dolphinscheduler.127.0.0.1.nip.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dolphinscheduler-api
            port:
              number: 12345

---
# MinIO Console Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minio-console-ingress
  namespace: data-platform
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "selfsigned"
    # Cloudflare Access Authentication
    nginx.ingress.kubernetes.io/auth-url: "https://qagi.cloudflareaccess.com/cdn-cgi/access/authorize"
    nginx.ingress.kubernetes.io/auth-signin: "https://qagi.cloudflareaccess.com/cdn-cgi/access/login?redirect_url=$scheme://$host$request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "cf-access-jwt-assertion"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $cf_access_user $upstream_http_cf_access_authenticated_user_email;
      auth_request_set $cf_access_groups $upstream_http_cf_access_groups;
      proxy_set_header CF-Access-Authenticated-User-Email $cf_access_user;
      proxy_set_header X-FORWARDED-USER $cf_access_user;
      proxy_set_header X-WEBAUTH-EMAIL $cf_access_user;
    # Portal service discovery annotations
    portal.254carbon.com/service-id: "minio"
    portal.254carbon.com/service-name: "MinIO"
    portal.254carbon.com/service-category: "Storage"
    portal.254carbon.com/service-description: "S3-compatible object storage console."
    portal.254carbon.com/service-icon: "ü™£"
    portal.254carbon.com/use-cloudflare-access: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - minio.254carbon.com
    secretName: minio-tls
  rules:
  - host: minio.254carbon.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: minio-console
            port:
              number: 9001
  - host: minio.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: minio-console
            port:
              number: 9001
