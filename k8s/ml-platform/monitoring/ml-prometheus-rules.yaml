apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ml-platform-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack-prometheus
    role: alert-rules
spec:
  groups:
  - name: ray-serve-alerts
    interval: 30s
    rules:
    - alert: RayServeHighLatency
      expr: histogram_quantile(0.99, sum(rate(ray_serve_deployment_request_latency_ms_bucket[5m])) by (le)) > 100
      for: 5m
      labels:
        severity: warning
        component: ray-serve
      annotations:
        summary: "Ray Serve P99 latency is high"
        description: "Ray Serve P99 latency is {{ $value }}ms (threshold: 100ms)"
    
    - alert: RayServeHighErrorRate
      expr: sum(rate(ray_serve_deployment_error_counter[5m])) / sum(rate(ray_serve_deployment_request_counter[5m])) > 0.05
      for: 5m
      labels:
        severity: critical
        component: ray-serve
      annotations:
        summary: "Ray Serve error rate is high"
        description: "Ray Serve error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
    
    - alert: RayClusterNodeDown
      expr: up{job="ray-cluster"} == 0
      for: 2m
      labels:
        severity: critical
        component: ray-cluster
      annotations:
        summary: "Ray cluster node is down"
        description: "Ray cluster node {{ $labels.instance }} has been down for more than 2 minutes"
    
    - alert: RayClusterLowWorkers
      expr: count(up{job="ray-cluster",ray_node_type="worker"}) < 2
      for: 5m
      labels:
        severity: warning
        component: ray-cluster
      annotations:
        summary: "Ray cluster has insufficient workers"
        description: "Ray cluster has only {{ $value }} worker(s) available"
  
  - name: feast-alerts
    interval: 30s
    rules:
    - alert: FeastServerDown
      expr: up{job="feast-server"} == 0
      for: 2m
      labels:
        severity: critical
        component: feast
      annotations:
        summary: "Feast server is down"
        description: "Feast server {{ $labels.instance }} has been down for more than 2 minutes"
    
    - alert: FeastHighFeatureLatency
      expr: histogram_quantile(0.95, sum(rate(feast_feature_serving_latency_ms_bucket[5m])) by (le)) > 10
      for: 5m
      labels:
        severity: warning
        component: feast
      annotations:
        summary: "Feast feature serving latency is high"
        description: "Feast P95 feature serving latency is {{ $value }}ms (threshold: 10ms)"
  
  - name: ml-model-alerts
    interval: 30s
    rules:
    - alert: MLModelPredictionFailures
      expr: sum(rate(ray_serve_deployment_error_counter{deployment="mlflow-model"}[5m])) > 0.1
      for: 5m
      labels:
        severity: warning
        component: ml-model
      annotations:
        summary: "ML model prediction failures detected"
        description: "ML model is experiencing {{ $value }} prediction failures per second"
    
    - alert: MLModelLowThroughput
      expr: sum(rate(ray_serve_deployment_request_counter{deployment="mlflow-model"}[5m])) < 0.01
      for: 10m
      labels:
        severity: info
        component: ml-model
      annotations:
        summary: "ML model has low prediction throughput"
        description: "ML model is receiving {{ $value }} requests per second"



