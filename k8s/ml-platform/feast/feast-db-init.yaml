apiVersion: batch/v1
kind: Job
metadata:
  name: feast-db-init
  namespace: data-platform
  labels:
    app: feast
    component: db-init
spec:
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: feast
        component: db-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: postgres-init
        image: postgres:14
        command:
        - /bin/sh
        - -c
        - |
          echo "Creating Feast database and user..."
          export PGPASSWORD=postgres
          
          # Create user if not exists
          psql -h postgres-shared-service.data-platform.svc.cluster.local -U postgres -tc \
            "SELECT 1 FROM pg_user WHERE usename = 'feast'" | grep -q 1 || \
          psql -h postgres-shared-service.data-platform.svc.cluster.local -U postgres -c \
            "CREATE USER feast WITH PASSWORD 'feast';"
          
          # Create database if not exists
          psql -h postgres-shared-service.data-platform.svc.cluster.local -U postgres -tc \
            "SELECT 1 FROM pg_database WHERE datname = 'feast'" | grep -q 1 || \
          psql -h postgres-shared-service.data-platform.svc.cluster.local -U postgres -c \
            "CREATE DATABASE feast OWNER feast;"
          
          # Grant privileges
          psql -h postgres-shared-service.data-platform.svc.cluster.local -U postgres -c \
            "GRANT ALL PRIVILEGES ON DATABASE feast TO feast;"
          
          echo "Feast database initialized successfully"
        env:
        - name: PGPASSWORD
          value: "postgres"



