apiVersion: batch/v1
kind: Job
metadata:
  name: feast-init
  namespace: data-platform
  labels:
    app: feast
    component: init
spec:
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: feast
        component: init-job
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: postgres:15
        command:
        - sh
        - -c
        - |
          until pg_isready -h postgres-shared-service -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready"
      - name: wait-for-redis
        image: redis:7-alpine
        command:
        - sh
        - -c
        - |
          until redis-cli -h redis-service ping; do
            echo "Waiting for Redis..."
            sleep 2
          done
          echo "Redis is ready"
      containers:
      - name: feast-init
        image: feastdev/feature-server:0.35.0
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Initializing Feast feature store..."
          
          cd /feast/feature_repo
          
          # Create PostgreSQL database if it doesn't exist
          PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -U $POSTGRES_USER -tc "SELECT 1 FROM pg_database WHERE datname = 'feast'" | grep -q 1 || \
            PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -U $POSTGRES_USER -c "CREATE DATABASE feast"
          
          echo "Applying Feast feature definitions..."
          feast apply
          
          echo "Feast initialization completed successfully"
          
          # Show registered features
          feast feature-views list
          feast entities list
        env:
        - name: FEAST_FEATURE_STORE_PATH
          value: /feast/feature_repo
        - name: POSTGRES_HOST
          value: postgres-shared-service
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_DB
          value: feast
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: postgres
        - name: REDIS_HOST
          value: redis-service
        - name: REDIS_PORT
          value: "6379"
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1
            memory: 2Gi
        volumeMounts:
        - name: feature-repo
          mountPath: /feast/feature_repo
      volumes:
      - name: feature-repo
        configMap:
          name: feast-feature-repo



