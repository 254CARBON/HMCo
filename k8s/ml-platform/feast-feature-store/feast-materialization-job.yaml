apiVersion: batch/v1
kind: CronJob
metadata:
  name: feast-materialize-hourly
  namespace: data-platform
  labels:
    app: feast
    component: materialization
spec:
  schedule: "5 * * * *"  # Every hour at 5 minutes past
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: feast
            component: materialization-job
        spec:
          restartPolicy: OnFailure
          containers:
          - name: feast-materialize
            image: feastdev/feature-server:0.35.0
            command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Starting Feast materialization..."
              cd /feast/feature_repo
              
              # Initialize Feast if needed
              feast apply
              
              # Materialize features from offline store to online store
              feast materialize-incremental $(date -u -d '2 hours ago' +%Y-%m-%dT%H:%M:%S)
              
              echo "Materialization completed successfully"
            env:
            - name: FEAST_FEATURE_STORE_PATH
              value: /feast/feature_repo
            - name: POSTGRES_HOST
              value: postgres-shared-service
            - name: POSTGRES_DB
              value: feast
            - name: POSTGRES_USER
              value: postgres
            - name: POSTGRES_PASSWORD
              value: postgres
            - name: REDIS_HOST
              value: redis-service
            - name: REDIS_PORT
              value: "6379"
            resources:
              requests:
                cpu: 1
                memory: 2Gi
              limits:
                cpu: 2
                memory: 4Gi
            volumeMounts:
            - name: feature-repo
              mountPath: /feast/feature_repo
          volumes:
          - name: feature-repo
            configMap:
              name: feast-feature-repo
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: feast-materialize-daily
  namespace: data-platform
  labels:
    app: feast
    component: materialization
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: feast
            component: materialization-job
        spec:
          restartPolicy: OnFailure
          containers:
          - name: feast-materialize
            image: feastdev/feature-server:0.35.0
            command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Starting daily Feast materialization..."
              cd /feast/feature_repo
              
              # Full materialization for daily features
              feast materialize $(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%S) $(date -u +%Y-%m-%dT%H:%M:%S)
              
              echo "Daily materialization completed"
            env:
            - name: FEAST_FEATURE_STORE_PATH
              value: /feast/feature_repo
            - name: POSTGRES_HOST
              value: postgres-shared-service
            - name: POSTGRES_DB
              value: feast
            - name: POSTGRES_USER
              value: postgres
            - name: POSTGRES_PASSWORD
              value: postgres
            - name: REDIS_HOST
              value: redis-service
            resources:
              requests:
                cpu: 2
                memory: 4Gi
              limits:
                cpu: 4
                memory: 8Gi
            volumeMounts:
            - name: feature-repo
              mountPath: /feast/feature_repo
          volumes:
          - name: feature-repo
            configMap:
              name: feast-feature-repo



