---
# Trino Query Result Caching Configuration
# Improves query performance by caching frequently accessed results

apiVersion: v1
kind: ConfigMap
metadata:
  name: trino-coordinator-config
  namespace: data-platform
  labels:
    app: trino
    component: coordinator
data:
  config.properties: |
    coordinator=true
    node-scheduler.include-coordinator=false
    http-server.http.port=8080
    discovery.uri=http://trino-coordinator:8080
    
    # Query result caching
    query.max-memory=50GB
    query.max-memory-per-node=8GB
    query.max-total-memory-per-node=10GB
    
    # Performance tuning
    query.min-expire-age=30m
    query.max-run-time=10m
    query.max-stage-count=200
    
    # Spill to disk for large queries
    spill-enabled=true
    spiller-spill-path=/tmp/trino-spill
    spill-compression-enabled=true
    spill-encryption-enabled=false
    
    # Distributed join optimization
    join-distribution-type=AUTOMATIC
    join-reordering-strategy=AUTOMATIC
    
    # Cache configuration
    query-result-cache-enabled=true
    query-result-cache-max-ttl=24h
    query-result-cache-max-size=1GB

  jvm.config: |
    -server
    -Xmx8G
    -Xms8G
    -XX:+UseG1GC
    -XX:G1HeapRegionSize=32M
    -XX:+UseGCOverheadLimit
    -XX:+ExplicitGCInvokesConcurrent
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:+ExitOnOutOfMemoryError
    -Djdk.attach.allowAttachSelf=true
    -Djdk.nio.maxCachedBufferSize=2000000

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: trino-worker-config
  namespace: data-platform
  labels:
    app: trino
    component: worker
data:
  config.properties: |
    coordinator=false
    http-server.http.port=8080
    discovery.uri=http://trino-coordinator:8080
    
    # Worker resources
    query.max-memory=50GB
    query.max-memory-per-node=16GB
    query.max-total-memory-per-node=20GB
    
    # Spill configuration
    spill-enabled=true
    spiller-spill-path=/tmp/trino-spill
    spill-compression-enabled=true
    
    # Task concurrency
    task.max-worker-threads=32
    task.min-drivers=2
    task.concurrency=16

  jvm.config: |
    -server
    -Xmx16G
    -Xms16G
    -XX:+UseG1GC
    -XX:G1HeapRegionSize=32M
    -XX:+UseGCOverheadLimit
    -XX:+ExplicitGCInvokesConcurrent
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:+ExitOnOutOfMemoryError
    -Djdk.attach.allowAttachSelf=true
    -Djdk.nio.maxCachedBufferSize=2000000

---
# Trino Iceberg Catalog with Caching
apiVersion: v1
kind: ConfigMap
metadata:
  name: trino-catalog-iceberg
  namespace: data-platform
  labels:
    app: trino
    component: catalog
data:
  iceberg.properties: |
    connector.name=iceberg
    iceberg.catalog.type=rest
    iceberg.rest-catalog.uri=http://iceberg-rest-catalog:8181
    
    # File format optimization
    iceberg.file-format=PARQUET
    iceberg.compression-codec=ZSTD
    iceberg.parquet.use-column-names=true
    
    # Caching configuration
    iceberg.metadata-cache-enabled=true
    iceberg.metadata-cache-ttl=1h
    iceberg.metadata-cache-max-entries=10000
    
    # Query optimization
    iceberg.split-size=128MB
    iceberg.min-split-size=64MB
    iceberg.target-max-file-size=512MB
    
    # Parallelism
    iceberg.max-workers=32
    iceberg.worker-thread-count=16


